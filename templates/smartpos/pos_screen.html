{% extends 'smartpos/base.html' %} {% block title %}POS - SmartPOS{% endblock %}
{% block extra_css %}
<style>
  .pos-container {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 20px;
    height: calc(100vh - 150px);
  }

  .products-section {
    display: flex;
    flex-direction: column;
  }

  .search-bar {
    margin-bottom: 15px;
  }

  .search-bar input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1rem;
  }

  .category-filter {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    overflow-x: auto;
    padding-bottom: 10px;
  }

  .category-btn {
    padding: 8px 15px;
    background: #ecf0f1;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s;
    white-space: nowrap;
  }

  .category-btn.active {
    background: #e74c3c;
    color: white;
  }

  .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
    overflow-y: auto;
    flex: 1;
    padding-right: 10px;
  }

  .product-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
  }

  .product-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-3px);
  }

  .product-card.selected {
    border-color: #e74c3c;
    background: rgba(231, 76, 60, 0.05);
  }

  .product-name {
    font-weight: 600;
    margin: 8px 0;
    font-size: 0.9rem;
  }

  .product-price {
    color: var(--secondary);
    font-weight: 700;
    font-size: 1.1rem;
  }

  /* Cart Sidebar */
  .cart-section {
    background: white;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .cart-header {
    background: var(--primary);
    color: white;
    padding: 15px;
    border-radius: 8px 8px 0 0;
    font-weight: 600;
  }

  .cart-items {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
  }

  .cart-item {
    background: #f9f9f9;
    padding: 10px;
    margin: 8px 0;
    border-radius: 5px;
    border-left: 3px solid var(--secondary);
  }

  .cart-item-name {
    font-weight: 600;
    font-size: 0.9rem;
  }

  .cart-item-qty {
    display: flex;
    gap: 5px;
    margin: 5px 0;
    font-size: 0.85rem;
  }

  .qty-btn {
    width: 20px;
    height: 20px;
    padding: 0;
    border: 1px solid #ddd;
    background: white;
    cursor: pointer;
    border-radius: 3px;
    font-size: 0.8rem;
  }

  .cart-item-price {
    color: var(--secondary);
    font-weight: 600;
    text-align: right;
  }

  .cart-item-remove {
    font-size: 0.8rem;
    color: #e74c3c;
    cursor: pointer;
    margin-top: 5px;
  }

  .cart-footer {
    border-top: 1px solid #eee;
    padding: 15px;
  }

  .cart-summary {
    margin-bottom: 15px;
  }

  .summary-line {
    display: flex;
    justify-content: space-between;
    margin: 5px 0;
    font-size: 0.9rem;
  }

  .summary-total {
    display: flex;
    justify-content: space-between;
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--secondary);
    border-top: 1px solid #eee;
    padding-top: 10px;
    margin-top: 10px;
  }

  .payment-section {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
  }

  .payment-method {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 10px;
  }

  .payment-btn {
    padding: 8px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.3s;
  }

  .payment-btn.active {
    background: var(--secondary);
    color: white;
    border-color: var(--secondary);
  }

  .checkout-btn {
    width: 100%;
    padding: 12px;
    background: var(--success);
    color: white;
    border: none;
    border-radius: 5px;
    font-weight: 600;
    cursor: pointer;
    font-size: 1rem;
  }

  .checkout-btn:hover {
    background: #229954;
  }

  .checkout-btn:disabled {
    background: #95a5a6;
    cursor: not-allowed;
  }

  .clear-btn {
    width: 100%;
    padding: 10px;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9rem;
    margin-bottom: 10px;
  }

  .modal-custom {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
  }

  .modal-content-custom {
    background-color: white;
    margin: 5% auto;
    padding: 30px;
    border-radius: 10px;
    width: 90%;
    max-width: 400px;
  }

  .input-group-custom {
    margin: 15px 0;
  }

  .input-group-custom label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
  }

  .input-group-custom input,
  .input-group-custom select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
  }

  .modal-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
  }

  .modal-buttons button {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
  }

  .btn-confirm {
    background: var(--success);
    color: white;
  }

  .btn-cancel {
    background: #bdc3c7;
    color: white;
  }

  .alert-custom {
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 5px;
    display: none;
  }

  .alert-success-custom {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .alert-error-custom {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
</style>
{% endblock %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="fas fa-shopping-cart"></i> Point of Sale</h1>
  <div>
    <span class="badge bg-primary me-2">Cashier: {{ user.username }}</span>
    <span class="badge bg-info" id="current-time"></span>
  </div>
</div>

<div class="pos-container">
  <!-- Products Section -->
  <div class="products-section">
    <div class="search-bar">
      <input
        type="text"
        id="searchInput"
        placeholder="Search products or scan barcode..."
      />
    </div>

    <div class="category-filter">
      <button class="category-btn active" data-category="">All Products</button>
      {% for category in categories %}
      <button class="category-btn" data-category="{{ category.id }}">
        {{ category.name }}
      </button>
      {% endfor %}
    </div>

    <div class="products-grid" id="productsGrid">
      <!-- Products will be loaded here via JavaScript -->
    </div>
  </div>

  <!-- Cart Section -->
  <div class="cart-section">
    <div class="cart-header"><i class="fas fa-shopping-bag"></i> Cart</div>

    <div id="alertBox" class="alert-custom alert-success-custom"></div>

    <div class="cart-items" id="cartItems">
      <p style="text-align: center; color: #999; padding: 20px">
        Cart is empty
      </p>
    </div>

    <div class="cart-footer">
      <div class="cart-summary">
        <div class="summary-line">
          <span>Subtotal:</span>
          <span id="subtotal">KES 0.00</span>
        </div>
        <div class="summary-line">
          <span>Discount:</span>
          <input
            type="number"
            id="discountInput"
            min="0"
            step="0.01"
            style="width: 80px; padding: 3px; border: 1px solid #ddd"
            value="0"
          />
        </div>
        <div class="summary-line">
          <span>Tax (16%):</span>
          <span id="tax">KES 0.00</span>
        </div>
      </div>

      <div class="summary-total">
        <span>TOTAL:</span>
        <span id="total">KES 0.00</span>
      </div>

      <div class="payment-section">
        <label style="font-size: 0.9rem; font-weight: 600"
          >Payment Method</label
        >
        <div class="payment-method">
          <button class="payment-btn active" data-method="cash">
            <i class="fas fa-money-bill"></i> Cash
          </button>
          <button class="payment-btn" data-method="mpesa">
            <i class="fas fa-mobile-alt"></i> M-Pesa
          </button>
          <button class="payment-btn" data-method="card">
            <i class="fas fa-credit-card"></i> Card
          </button>
          <button class="payment-btn" data-method="split">
            <i class="fas fa-split"></i> Split
          </button>
        </div>
      </div>

      <button class="checkout-btn" id="checkoutBtn" onclick="processCheckout()">
        <i class="fas fa-check"></i> CHECKOUT
      </button>
      <button class="clear-btn" onclick="clearCart()">
        <i class="fas fa-trash"></i> CLEAR CART
      </button>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div id="paymentModal" class="modal-custom">
  <div class="modal-content-custom">
    <h5 style="margin-bottom: 20px">Complete Payment</h5>

    <div class="input-group-custom">
      <label>Amount Due:</label>
      <input type="text" id="amountDue" readonly style="background: #f0f0f0" />
    </div>

    <div class="input-group-custom" id="mobileInputGroup" style="display: none">
      <label>Phone Number (M-Pesa):</label>
      <input type="text" id="mobileNumber" placeholder="+254..." />
    </div>

    <div
      class="input-group-custom"
      id="referenceInputGroup"
      style="display: none"
    >
      <label>Reference Number:</label>
      <input
        type="text"
        id="referenceNumber"
        placeholder="Enter transaction reference"
      />
    </div>

    <div class="input-group-custom">
      <label>Amount Paid:</label>
      <input type="number" id="amountPaid" step="0.01" min="0" />
    </div>

    <div class="input-group-custom">
      <label>Change:</label>
      <input type="text" id="change" readonly style="background: #f0f0f0" />
    </div>

    <div class="modal-buttons">
      <button class="btn-confirm" onclick="confirmPayment()">
        <i class="fas fa-check"></i> Confirm
      </button>
      <button class="btn-cancel" onclick="closePaymentModal()">
        <i class="fas fa-times"></i> Cancel
      </button>
    </div>
  </div>
</div>

<!-- Receipt Modal -->
<div id="receiptModal" class="modal-custom">
  <div class="modal-content-custom" style="max-width: 350px">
    <div style="text-align: center; margin-bottom: 20px">
      <h4>SmartPOS Receipt</h4>
      <p style="font-size: 0.8rem; color: #999">
        Receipt #<span id="receiptNumber"></span>
      </p>
    </div>

    <div
      id="receiptContent"
      style="
        font-size: 0.85rem;
        font-family: monospace;
        border-top: 1px dashed #ccc;
        padding-top: 10px;
        border-bottom: 1px dashed #ccc;
        padding-bottom: 10px;
        margin-bottom: 15px;
      "
    >
      <!-- Receipt items will be populated here -->
    </div>

    <div
      style="
        text-align: center;
        font-size: 0.8rem;
        color: #999;
        margin-bottom: 20px;
      "
    >
      <p>Thank you for your purchase!</p>
      <p id="receiptTime"></p>
    </div>

    <div class="modal-buttons">
      <button class="btn-confirm" onclick="printReceipt()">
        <i class="fas fa-print"></i> Print
      </button>
      <button class="btn-cancel" onclick="startNewTransaction()">
        <i class="fas fa-plus"></i> New Sale
      </button>
    </div>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script>
  // ===== STATE MANAGEMENT =====
  let cart = {};
  let selectedPaymentMethod = 'cash';
  const products = {{ products|safe|default:"[]" }};

  // Convert Django queryset to JavaScript object
  const productsData = {};
  {% for product in products %}
  productsData['{{ product.id }}'] = {
      id: '{{ product.id }}',
      name: '{{ product.name }}',
      price: {{ product.selling_price }},
      cost: {{ product.cost_price }},
      barcode: '{{ product.barcode }}',
      category: '{{ product.category.id }}',
      image: '{{ product.image.url }}'
  };
  {% endfor %}

  // ===== UTILITY FUNCTIONS =====
  function updateTime() {
      const now = new Date();
      document.getElementById('current-time').textContent = now.toLocaleTimeString();
  }
  setInterval(updateTime, 1000);

  function formatCurrency(amount) {
      return 'KES ' + parseFloat(amount).toFixed(2);
  }

  function showAlert(message, type = 'success') {
      const alertBox = document.getElementById('alertBox');
      alertBox.textContent = message;
      alertBox.style.display = 'block';
      alertBox.className = 'alert-custom alert-' + type + '-custom';
      setTimeout(() => alertBox.style.display = 'none', 3000);
  }

  // ===== CART FUNCTIONS =====
  function addToCart(productId) {
      if (!productsData[productId]) {
          showAlert('Product not found', 'error');
          return;
      }

      const product = productsData[productId];

      if (cart[productId]) {
          cart[productId].quantity += 1;
      } else {
          cart[productId] = {
              ...product,
              quantity: 1
          };
      }

      updateCartDisplay();
      showAlert(product.name + ' added to cart');
  }

  function removeFromCart(productId) {
      delete cart[productId];
      updateCartDisplay();
  }

  function updateQuantity(productId, delta) {
      if (cart[productId]) {
          cart[productId].quantity += delta;
          if (cart[productId].quantity <= 0) {
              removeFromCart(productId);
          } else {
              updateCartDisplay();
          }
      }
  }

  function clearCart() {
      if (confirm('Clear cart?')) {
          cart = {};
          updateCartDisplay();
      }
  }

  function updateCartDisplay() {
      const cartItemsDiv = document.getElementById('cartItems');

      if (Object.keys(cart).length === 0) {
          cartItemsDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Cart is empty</p>';
      } else {
          let html = '';
          for (const [productId, item] of Object.entries(cart)) {
              const subtotal = item.price * item.quantity;
              html += `
                  <div class="cart-item">
                      <div class="cart-item-name">${item.name}</div>
                      <div class="cart-item-qty">
                          <button class="qty-btn" onclick="updateQuantity('${productId}', -1)">-</button>
                          <span style="flex: 1; text-align: center;">${item.quantity}</span>
                          <button class="qty-btn" onclick="updateQuantity('${productId}', 1)">+</button>
                          <button class="qty-btn" onclick="removeFromCart('${productId}')" style="background: #ffe0e0;">Ã—</button>
                      </div>
                      <div class="cart-item-price">${formatCurrency(subtotal)}</div>
                  </div>
              `;
          }
          cartItemsDiv.innerHTML = html;
      }

      updateTotals();
  }

  function updateTotals() {
      let subtotal = 0;
      for (const item of Object.values(cart)) {
          subtotal += item.price * item.quantity;
      }

      const discount = parseFloat(document.getElementById('discountInput').value) || 0;
      const afterDiscount = subtotal - discount;
      const tax = afterDiscount * 0.16;
      const total = afterDiscount + tax;

      document.getElementById('subtotal').textContent = formatCurrency(subtotal);
      document.getElementById('tax').textContent = formatCurrency(tax);
      document.getElementById('total').textContent = formatCurrency(total);
      document.getElementById('amountDue').value = formatCurrency(total);
  }

  // ===== PAYMENT FUNCTIONS =====
  function processCheckout() {
      if (Object.keys(cart).length === 0) {
          showAlert('Cart is empty', 'error');
          return;
      }

      document.getElementById('paymentModal').style.display = 'block';
      document.getElementById('amountPaid').focus();
  }

  function closePaymentModal() {
      document.getElementById('paymentModal').style.display = 'none';
  }

  function confirmPayment() {
      const amountDue = parseFloat(document.getElementById('amountDue').value.replace('KES ', ''));
      const amountPaid = parseFloat(document.getElementById('amountPaid').value);

      if (!amountPaid || amountPaid < amountDue) {
          showAlert('Insufficient payment', 'error');
          return;
      }

      const change = amountPaid - amountDue;
      document.getElementById('change').value = formatCurrency(change);

      // Prepare sale data
      const saleData = {
          total_amount: parseFloat(document.getElementById('subtotal').textContent.replace('KES ', '')),
          discount: parseFloat(document.getElementById('discountInput').value) || 0,
          tax: parseFloat(document.getElementById('tax').textContent.replace('KES ', '')),
          final_amount: amountDue,
          payment_method: selectedPaymentMethod,
          reference_number: document.getElementById('referenceNumber').value,
          items: Object.entries(cart).map(([id, item]) => ({
              product_id: id,
              quantity: item.quantity,
              unit_price: item.price
          }))
      };

      // Send to server
      fetch('{% url "create_sale" %}', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify(saleData)
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              closePaymentModal();
              showReceipt(data.sale_id, saleData, change);
          } else {
              showAlert('Payment failed', 'error');
          }
      })
      .catch(error => {
          console.error('Error:', error);
          showAlert('Network error', 'error');
      });
  }

  function showReceipt(saleId, saleData, change) {
      let receiptHTML = '';
      for (const item of saleData.items) {
          const product = productsData[item.product_id];
          const subtotal = item.unit_price * item.quantity;
          receiptHTML += `<div style="display: flex; justify-content: space-between; margin: 5px 0;">
              <span>${product.name} x${item.quantity}</span>
              <span>${formatCurrency(subtotal)}</span>
          </div>`;
      }

      document.getElementById('receiptNumber').textContent = saleId.substring(0, 8);
      document.getElementById('receiptContent').innerHTML = receiptHTML + `
          <div style="margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 10px;">
              <div style="display: flex; justify-content: space-between;"><span>Subtotal:</span><span>${formatCurrency(saleData.total_amount)}</span></div>
              <div style="display: flex; justify-content: space-between;"><span>Discount:</span><span>-${formatCurrency(saleData.discount)}</span></div>
              <div style="display: flex; justify-content: space-between;"><span>Tax:</span><span>${formatCurrency(saleData.tax)}</span></div>
              <div style="display: flex; justify-content: space-between; font-weight: bold;"><span>TOTAL:</span><span>${formatCurrency(saleData.final_amount)}</span></div>
              <div style="display: flex; justify-content: space-between; margin-top: 10px;"><span>Change:</span><span>${formatCurrency(change)}</span></div>
          </div>
      `;
      document.getElementById('receiptTime').textContent = new Date().toLocaleString();
      document.getElementById('receiptModal').style.display = 'block';
  }

  function printReceipt() {
      window.print();
  }

  function startNewTransaction() {
      document.getElementById('receiptModal').style.display = 'none';
      cart = {};
      document.getElementById('discountInput').value = 0;
      updateCartDisplay();
      document.getElementById('searchInput').focus();
  }

  // ===== PRODUCT DISPLAY =====
  function displayProducts(filterCategory = '') {
      const grid = document.getElementById('productsGrid');
      let html = '';

      for (const [id, product] of Object.entries(productsData)) {
          if (filterCategory && product.category !== filterCategory) continue;

          html += `
              <div class="product-card" onclick="addToCart('${id}')">
                  <div style="height: 60px; background: #f5f5f5; border-radius: 5px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center;">
                      <i class="fas fa-box" style="color: #bbb; font-size: 1.5rem;"></i>
                  </div>
                  <div class="product-name">${product.name}</div>
                  <div class="product-price">${formatCurrency(product.price)}</div>
              </div>
          `;
      }

      grid.innerHTML = html;
  }

  // ===== EVENT LISTENERS =====
  document.addEventListener('DOMContentLoaded', () => {
      displayProducts();
      updateTime();
  });

  // Search functionality
  document.getElementById('searchInput').addEventListener('keyup', (e) => {
      const search = e.target.value.toLowerCase();
      const grid = document.getElementById('productsGrid');
      let html = '';

      for (const [id, product] of Object.entries(productsData)) {
          if (product.name.toLowerCase().includes(search) || product.barcode.includes(search)) {
              html += `
                  <div class="product-card" onclick="addToCart('${id}')">
                      <div style="height: 60px; background: #f5f5f5; border-radius: 5px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center;">
                          <i class="fas fa-box" style="color: #bbb; font-size: 1.5rem;"></i>
                      </div>
                      <div class="product-name">${product.name}</div>
                      <div class="product-price">${formatCurrency(product.price)}</div>
                  </div>
              `;
          }
      }

      grid.innerHTML = html || '<p style="grid-column: 1/-1; text-align: center; color: #999;">No products found</p>';
  });

  // Category filter
  document.querySelectorAll('.category-btn').forEach(btn => {
      btn.addEventListener('click', () => {
          document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          displayProducts(btn.getAttribute('data-category'));
      });
  });

  // Payment method selection
  document.querySelectorAll('.payment-btn').forEach(btn => {
      btn.addEventListener('click', () => {
          document.querySelectorAll('.payment-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedPaymentMethod = btn.getAttribute('data-method');

          // Show/hide additional fields based on payment method
          document.getElementById('mobileInputGroup').style.display = selectedPaymentMethod === 'mpesa' ? 'block' : 'none';
          document.getElementById('referenceInputGroup').style.display = ['mpesa', 'card'].includes(selectedPaymentMethod) ? 'block' : 'none';
      });
  });

  // Calculate change on input
  document.getElementById('amountPaid').addEventListener('input', () => {
      const amountDue = parseFloat(document.getElementById('amountDue').value.replace('KES ', ''));
      const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
      const change = Math.max(0, amountPaid - amountDue);
      document.getElementById('change').value = formatCurrency(change);
  });

  // Update totals on discount change
  document.getElementById('discountInput').addEventListener('change', updateTotals);

  // Close modal when clicking outside
  window.addEventListener('click', (e) => {
      const paymentModal = document.getElementById('paymentModal');
      const receiptModal = document.getElementById('receiptModal');
      if (e.target === paymentModal) closePaymentModal();
      if (e.target === receiptModal) document.getElementById('receiptModal').style.display = 'none';
  });
</script>
{% endblock %}
